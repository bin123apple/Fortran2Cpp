MODULE sla_S2TP_mod
  IMPLICIT NONE
CONTAINS
  SUBROUTINE sla_S2TP (RA, DEC, RAZ, DECZ, XI, ETA, J)
    IMPLICIT NONE
    REAL, INTENT(IN) :: RA, DEC, RAZ, DECZ
    REAL, INTENT(OUT) :: XI, ETA
    INTEGER, INTENT(OUT) :: J
    REAL :: SDECZ, SDEC, CDECZ, CDEC, RADIF, SRADIF, CRADIF, DENOM
    REAL, PARAMETER :: TINY = 1E-6

    SDECZ = SIN(DECZ)
    SDEC = SIN(DEC)
    CDECZ = COS(DECZ)
    CDEC = COS(DEC)
    RADIF = RA - RAZ
    SRADIF = SIN(RADIF)
    CRADIF = COS(RADIF)

    DENOM = SDEC*SDECZ + CDEC*CDECZ*CRADIF

    IF (DENOM > TINY) THEN
       J = 0
    ELSE IF (DENOM >= 0.0) THEN
       J = 1
       DENOM = TINY
    ELSE IF (DENOM > -TINY) THEN
       J = 2
       DENOM = -TINY
    ELSE
       J = 3
    END IF

    XI = CDEC * SRADIF / DENOM
    ETA = (SDEC * CDECZ - CDEC * SDECZ * CRADIF) / DENOM
  END SUBROUTINE sla_S2TP
END MODULE sla_S2TP_mod

PROGRAM TestSla_S2TP
  USE sla_S2TP_mod
  IMPLICIT NONE
  REAL :: RA, DEC, RAZ, DECZ, XI, ETA
  INTEGER :: J

  ! Test case
  RA = 1.0
  DEC = 0.5
  RAZ = 0.3
  DECZ = 0.4
  CALL sla_S2TP(RA, DEC, RAZ, DECZ, XI, ETA, J)

  PRINT *, "Test - J:", J, "XI:", XI, "ETA:", ETA
END PROGRAM TestSla_S2TP