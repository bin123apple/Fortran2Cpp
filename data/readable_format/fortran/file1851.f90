! ELLEXT.f90
SUBROUTINE ELLEXT(XEXT,YEXT,IMAGE,XBASE,YBASE,XTOP,YTOP,MAXLEV,MAXPTS,MAXPAR,NLEVEL,LOGI,INTEN,ELLARR,LEVPT,STATUS)
  INTEGER :: XEXT,YEXT,XBASE,YBASE,XTOP,YTOP,MAXLEV,MAXPTS,MAXPAR,NLEVEL,STATUS
  REAL :: IMAGE(XEXT,YEXT), LOGI(MAXLEV), INTEN(2,MAXLEV), ELLARR(MAXPAR,MAXPTS,MAXLEV)
  INTEGER :: LEVPT(MAXLEV)
  INTEGER :: I, J, K, PTS, RLEVEL
  REAL :: PIXTHR, PIXVAL
  LOGICAL :: FULFLG

  ELLARR = -9.99E3
  LEVPT = 0
  PIXTHR = INTEN(1,1)
  FULFLG = .FALSE.
  RLEVEL = 0

  DO J = YBASE, YTOP
    DO I = XBASE, XTOP
      PIXVAL = IMAGE(I,J)
      IF (PIXVAL >= PIXTHR) THEN
        DO K = 1, MAXLEV
          IF (PIXVAL >= INTEN(1,K) .AND. PIXVAL <= INTEN(2,K)) THEN
            PTS = LEVPT(K) + 1
            IF (PTS <= MAXPTS) THEN
              ELLARR(1,PTS,K) = REAL(I)
              ELLARR(2,PTS,K) = REAL(J)
              LEVPT(K) = PTS
            ELSE
              FULFLG = .TRUE.
            END IF
            RLEVEL = MAX(K, RLEVEL)
          END IF
        END DO
      END IF
    END DO
  END DO

  NLEVEL = RLEVEL
  IF (.NOT. FULFLG) THEN
    STATUS = 0
  ELSE
    STATUS = 1
  END IF
END SUBROUTINE ELLEXT

PROGRAM TestELLEXT
  INTEGER, PARAMETER :: XEXT=10, YEXT=10, MAXLEV=2, MAXPTS=10, MAXPAR=2
  REAL, DIMENSION(XEXT,YEXT) :: IMAGE
  INTEGER :: XBASE, YBASE, XTOP, YTOP, NLEVEL, STATUS
  REAL, DIMENSION(MAXLEV) :: LOGI
  REAL, DIMENSION(2,MAXLEV) :: INTEN
  REAL, DIMENSION(MAXPAR,MAXPTS,MAXLEV) :: ELLARR
  INTEGER, DIMENSION(MAXLEV) :: LEVPT
  INTEGER :: i, j

  ! Initialize test data
  IMAGE = 0.0
  IMAGE(5,5) = 50.0
  IMAGE(6,6) = 60.0

  XBASE = 1
  YBASE = 1
  XTOP = XEXT
  YTOP = YEXT
  NLEVEL = MAXLEV
  INTEN(:,1) = (/40.0, 70.0/)
  INTEN(:,2) = (/70.0, 100.0/)

  CALL ELLEXT(XEXT, YEXT, IMAGE, XBASE, YBASE, XTOP, YTOP, MAXLEV, MAXPTS, MAXPAR, NLEVEL, LOGI, INTEN, ELLARR, LEVPT, STATUS)

  PRINT *, 'STATUS:', STATUS
  PRINT *, 'NLEVEL:', NLEVEL
  PRINT *, 'LEVPT:', LEVPT
  PRINT *, 'ELLARR(1,:,1):', (ELLARR(1,i,1), i=1,LEVPT(1))
  PRINT *, 'ELLARR(2,:,1):', (ELLARR(2,i,1), i=1,LEVPT(1))
END PROGRAM TestELLEXT